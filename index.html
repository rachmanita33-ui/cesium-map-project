<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Peta Digital Terban (Fixed)</title>
  
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    body, html { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
    #wadah-peta { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; }

    /* LOADING SCREEN */
    #layar-loading {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.9); z-index: 9999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        color: white; transition: opacity 0.5s; pointer-events: none;
    }
    .spinner {
        border: 5px solid #333; border-top: 5px solid #00d2ff;
        border-radius: 50%; width: 50px; height: 50px; animation: putar 1s linear infinite; margin-bottom: 20px;
    }
    @keyframes putar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* PANEL KONTROL KIRI */
    .panel-kiri { position: absolute; top: 20px; left: 20px; z-index: 20; display: flex; flex-direction: column; gap: 10px; }
    .grup-tombol { background: rgba(255,255,255,0.9); padding: 5px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    .label-grup { font-size: 10px; font-weight: bold; color: #666; margin-bottom: 5px; text-transform: uppercase; }
    
    button { padding: 8px 12px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; background: #fff; }
    button:hover { background: #f0f0f0; }
    .btn-sumber.aktif { background-color: #6f42c1; color: white; border-color:#6f42c1; } 
    .btn-camera.aktif { background-color: #007bff; color: white; border-color:#007bff; }

    /* PANEL KANAN (Fitur GeoJSON) */
    .panel-kanan { position: absolute; top: 20px; right: 20px; z-index: 10; background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 4px; display: none; flex-direction: column; gap: 10px; }
    
    /* PANEL INFO BAWAH */
    #panel-info { position: absolute; bottom: 80px; left: 20px; z-index: 20; width: 280px; background: white; padding: 15px; display: none; border-left: 5px solid #007bff; box-shadow: 0 0 15px rgba(0,0,0,0.3); border-radius: 5px; }
    #tabel-properti { width: 100%; border-collapse: collapse; font-size: 12px; }
    #tabel-properti td { border-bottom: 1px solid #eee; padding: 4px; }
    
    #btn-download { position: absolute; bottom: 20px; right: 20px; z-index: 99; background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 50px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.4); cursor: pointer; display: none; }
    
    /* DEBUG LOG (Pojok Kiri Bawah) */
    #debug-log { position: absolute; bottom: 0; left: 0; width: 100%; height: 100px; background: rgba(0,0,0,0.8); color: lime; font-family: monospace; font-size: 11px; overflow-y: scroll; z-index: 99999; padding: 10px; display: none; }
  </style>
</head>
<body>

  <div id="layar-loading">
      <div class="spinner"></div>
      <div id="teks-loading">Menyiapkan Peta Digital...</div>
  </div>

  <div id="wadah-peta"></div>
  <div id="debug-log"></div>

  <div class="panel-kiri">
    <div class="grup-tombol">
        <div class="label-grup">Sumber Data</div>
        <button id="btn3DTiles" class="btn-sumber aktif" onclick="gantiSumber('3dtiles')">3D Tiles (Real)</button>
        <button id="btnGeoJSON" class="btn-sumber" onclick="gantiSumber('geojson')">GeoJSON (Edit)</button>
    </div>
    <div class="grup-tombol">
        <div class="label-grup">Kamera</div>
        <button id="btn2D" class="btn-camera" onclick="modeKamera('2D')">2D</button>
        <button id="btn3D" class="btn-camera aktif" onclick="modeKamera('3D')">3D</button>
    </div>
    <button onclick="toggleDebug()" style="margin-top:10px; background:black; color:lime;">üõ† Cek Log</button>
  </div>

  <div class="panel-kanan" id="panel-fitur-geojson">
    <div style="display:flex; gap:5px;">
        <input type="text" id="inputCari" placeholder="Cari nama...">
        <button onclick="cariBangunan()">üîç</button>
    </div>
  </div>
  <button id="btn-download" onclick="downloadGeoJSON()">üíæ DOWNLOAD DATA BARU</button>

  <div id="panel-info">
    <h4 id="judul-panel">Info</h4>
    
    <div id="konten-geojson">
        <div style="text-align:center; margin-bottom:10px;">Luas: <b id="labelLuas" style="color:#007bff">0</b> m¬≤</div>
        <div style="margin-bottom:10px;"><label>Nama:</label><input type="text" id="inputNamaBaru" style="width:100%;"></div>
        <div style="margin-bottom:10px;"><label>Jenis:</label>
            <select id="inputJenisBaru" style="width:100%;">
                <option value="Lainnya">-- Pilih --</option>
                <option value="Rumah">Rumah</option>
                <option value="Kantor">Kantor</option>
                <option value="Sekolah">Sekolah</option>
                <option value="Toko">Toko</option>
            </select>
        </div>
        <button onclick="simpanEdit()" style="width:100%; background:#007bff; color:white; border:none; padding:8px;">Update Data</button>
    </div>

    <div id="konten-3dtiles" style="display:none;"><table id="tabel-properti"></table></div>
  </div>

  <script>
    // 1. TOKEN CESIUM (Jangan diubah)
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJjNjJmNjllYi0zNWY1LTRjNTUtYjEyZS0xZTJjZTFkYmNmNjciLCJpZCI6MzY3MTgyLCJpYXQiOjE3NjY0NDkyMTd9.04ove0_LwaphuhYqwBzNo8PQ-2ZiK0gXTY1E1Uiy5Kw'; 

    function logDebug(msg, tipe='info') {
        const d = document.getElementById('debug-log');
        d.innerHTML += `<div style="color:${tipe==='error'?'red':'lime'}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        console.log(msg);
    }

    // 2. SETUP VIEWER
    const viewer = new Cesium.Viewer('wadah-peta', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      imageryProvider: new Cesium.IonImageryProvider({ assetId: 3954 }), 
      geocoder: false, infoBox: false, selectionIndicator: true, timeline: false, animation: false, baseLayerPicker: true
    });

    // PENTING: Matikan Depth Test supaya data tidak tenggelam/bolong
    viewer.scene.globe.depthTestAgainstTerrain = false;

    // KAMERA START (Close Up & Miring)
    viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(110.37, -7.78, 400),
        orientation: { heading: 0.0, pitch: Cesium.Math.toRadians(-25.0), roll: 0.0 }
    });

    let geoJsonSource = null;
    let tilesetSource = null;
    let masterGeoJSON = null;
    let selectedIndex = -1;
    let currentMode = '3dtiles';

    // --- 3. FUNGSI LOAD DATA UTAMA ---
    async function initData() {
        try {
            // A. LOAD 3D TILES (Gedung Putih)
            logDebug("üîÑ Mengambil 3D Tiles...");
            tilesetSource = await Cesium.Cesium3DTileset.fromIonAssetId(4262559);
            viewer.scene.primitives.add(tilesetSource);
            
            // Fix Elevasi 3D Tiles (+140m)
            const heightOffset = 140.0;
            const boundingSphere = tilesetSource.boundingSphere;
            const cartographic = Cesium.Cartographic.fromCartesian(boundingSphere.center);
            const surface = Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, 0.0);
            const offset = Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, heightOffset);
            const translation = Cesium.Cartesian3.subtract(offset, surface, new Cesium.Cartesian3());
            tilesetSource.modelMatrix = Cesium.Matrix4.fromTranslation(translation);
            
            tilesetSource.style = new Cesium.Cesium3DTileStyle({ color: "color('orange', 1.0)" });
            logDebug("‚úÖ 3D Tiles Siap!");

            // B. LOAD GEOJSON (Gedung Oranye)
            logDebug("‚òÅÔ∏è Mengunduh GeoJSON dari Ion...");
            
            const resource = await Cesium.IonResource.fromAssetId(4268727);
            const json = await resource.fetchJson(); // Ambil Data Mentah
            masterGeoJSON = json; 
            
            // === RAHASIA AGAR TIDAK MELAYANG: clampToGround: true ===
            const ds = await Cesium.GeoJsonDataSource.load(json, {
                clampToGround: true 
            });
            // ========================================================

            geoJsonSource = ds;
            viewer.dataSources.add(ds);
            
            const entities = ds.entities.values;
            for (let i = 0; i < entities.length; i++) {
                const ent = entities[i];
                ent.indexAsli = i; 
                if (ent.polygon) {
                    // Paksa Reset Ketinggian
                    ent.polygon.perPositionHeight = false;
                    ent.polygon.heightReference = Cesium.HeightReference.CLAMP_TO_GROUND;
                    
                    // Extrude (Tinggi Gedung)
                    ent.polygon.extrudedHeightReference = Cesium.HeightReference.RELATIVE_TO_GROUND;
                    ent.polygon.extrudedHeight = 15;
                    
                    // Load Atribut
                    let jenis = ent.properties.jenis ? ent.properties.jenis.getValue() : "Lainnya";
                    let nama = ent.properties.name ? ent.properties.name.getValue() : "Tanpa Nama";
                    ent.jenisBangunan = jenis;
                    ent.name = nama;
                    updateWarna(ent, jenis);
                }
            }
            
            // Default GeoJSON Sembunyi
            geoJsonSource.show = false; 
            logDebug("‚úÖ GeoJSON Siap & Terpaku di Tanah!");

            // ZOOM CANTIK (Close Up)
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(110.374, -7.783, 350), 
                orientation: {
                    heading: 0.0,
                    pitch: Cesium.Math.toRadians(-30.0), 
                    roll: 0.0
                },
                duration: 2.5
            });

            document.getElementById('layar-loading').style.display = 'none';

        } catch (e) {
            logDebug("ERROR: " + e, 'error');
            alert("Gagal memuat data: " + e);
            document.getElementById('layar-loading').style.display = 'none';
        }
    }

    // Jalankan
    initData();

    // --- 4. GANTI MODE ---
    function gantiSumber(tipe) {
        currentMode = tipe;
        document.getElementById('panel-info').style.display = 'none';
        
        document.getElementById('btnGeoJSON').className = tipe==='geojson'?'btn-sumber aktif':'btn-sumber';
        document.getElementById('btn3DTiles').className = tipe==='3dtiles'?'btn-sumber aktif':'btn-sumber';
        
        const panelGeo = document.getElementById('panel-fitur-geojson');
        const btnDown = document.getElementById('btn-download');

        if (tipe === 'geojson') {
            if(geoJsonSource) {
                geoJsonSource.show = true;
                if(tilesetSource) tilesetSource.show = false;
                panelGeo.style.display = 'flex';
                btnDown.style.display = 'block';
                // Kamera diam (tidak zoom out)
            } else {
                alert("GeoJSON belum siap!");
            }
        } 
        else { // 3D Tiles
            if(tilesetSource) {
                tilesetSource.show = true;
                if(geoJsonSource) geoJsonSource.show = false;
                panelGeo.style.display = 'none';
                btnDown.style.display = 'none';
            }
        }
    }

    // --- 5. KLIK INTERAKSI ---
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction(function(movement) {
        const picked = viewer.scene.pick(movement.position);
        document.getElementById('panel-info').style.display = 'none';
        if (!Cesium.defined(picked)) return;

        // MODE GEOJSON (EDIT)
        if (currentMode === 'geojson' && picked.id && picked.id.indexAsli !== undefined) {
            selectedIndex = picked.id.indexAsli;
            const ent = picked.id;
            
            document.getElementById('konten-geojson').style.display = 'block';
            document.getElementById('konten-3dtiles').style.display = 'none';
            document.getElementById('judul-panel').innerText = "Edit Data";
            
            document.getElementById('inputNamaBaru').value = ent.name;
            document.getElementById('inputJenisBaru').value = ent.jenisBangunan || "Lainnya";

            if (masterGeoJSON) {
                const feature = masterGeoJSON.features[selectedIndex];
                const luas = turf.area(feature);
                document.getElementById('labelLuas').innerText = luas.toFixed(2);
            }
            document.getElementById('panel-info').style.display = 'block';
        }

        // MODE 3D TILES (INFO)
        else if (currentMode === '3dtiles' && picked instanceof Cesium.Cesium3DTileFeature) {
            document.getElementById('konten-geojson').style.display = 'none';
            document.getElementById('konten-3dtiles').style.display = 'block';
            document.getElementById('judul-panel').innerText = "Info Real";
            
            const tabel = document.getElementById('tabel-properti');
            tabel.innerHTML = "";
            const props = picked.getPropertyNames();
            if(props.length > 0) {
                props.forEach(p => tabel.innerHTML += `<tr><td>${p}</td><td>${picked.getProperty(p)}</td></tr>`);
            } else {
                tabel.innerHTML = "<tr><td>Info</td><td>Tidak ada atribut.</td></tr>";
            }
            document.getElementById('panel-info').style.display = 'block';
        }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    // --- FUNGSI PENDUKUNG ---
    function simpanEdit() {
        if(selectedIndex === -1) return;
        const nama = document.getElementById('inputNamaBaru').value;
        const jenis = document.getElementById('inputJenisBaru').value;
        
        const ent = geoJsonSource.entities.values[selectedIndex];
        ent.name = nama; ent.jenisBangunan = jenis;
        updateWarna(ent, jenis);
        
        if(masterGeoJSON) {
            masterGeoJSON.features[selectedIndex].properties.name = nama;
            masterGeoJSON.features[selectedIndex].properties.jenis = jenis;
        }
        alert("Tersimpan (RAM). Silakan Download.");
    }

    function updateWarna(ent, jenis) {
        let col = Cesium.Color.ORANGE;
        if(jenis === 'Sekolah') col = Cesium.Color.RED;
        else if(jenis === 'Kantor') col = Cesium.Color.BLUE;
        else if(jenis === 'Toko') col = Cesium.Color.GREEN;
        else if(jenis === 'Rumah') col = Cesium.Color.YELLOW;
        ent.polygon.material = col.withAlpha(1.0);
    }

    function downloadGeoJSON() {
        if (!masterGeoJSON) return;
        const s = JSON.stringify(masterGeoJSON, null, 2);
        const b = new Blob([s], {type: "application/json"});
        const u = URL.createObjectURL(b);
        const a = document.createElement('a');
        a.href = u; a.download = "data_final_updated.geojson";
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    
    function cariBangunan() {
        // 1. Ambil Input
        const input = document.getElementById('inputCari');
        if (!input) return; // Jaga-jaga kalau elemen hilang
        
        const kataKunci = input.value.toLowerCase();
        
        // 2. Cek Apakah Data GeoJSON Sudah Ada?
        if(!geoJsonSource) {
            alert("Data sedang dimuat dari Cloud, mohon tunggu sebentar...");
            return;
        }

        const entities = geoJsonSource.entities.values;
        let ketemu = false;

        // 3. Loop Pencarian (Versi Aman)
        for(let i = 0; i < entities.length; i++){
            const ent = entities[i];
            
            // Cek dulu: Apakah gedung ini punya nama? (Biar gak error)
            if (ent.name) {
                if(ent.name.toLowerCase().includes(kataKunci)){
                    
                    // KETEMU! Lakukan aksi:
                    
                    // a. Pastikan kita di mode GeoJSON (biar gedungnya kelihatan)
                    gantiSumber('geojson'); 

                    // b. Terbang ke gedung itu
                    viewer.flyTo(ent, {
                        duration: 1.5, 
                        offset: new Cesium.HeadingPitchRange(0, -0.5, 200)
                    });

                    // c. Pilih gedung (supaya panel edit langsung muncul)
                    viewer.selectedEntity = ent;
                    
                    ketemu = true;
                    break; // Stop mencari karena sudah ketemu
                }
            }
        }

        if (!ketemu) {
            alert("Gedung dengan nama '" + kataKunci + "' tidak ditemukan.");
        }
    }

    // Pastikan Enter juga jalan
    document.getElementById('inputCari').addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            cariBangunan();
        }
    });

    function toggleDebug() {
        const d = document.getElementById('debug-log');
        d.style.display = d.style.display === 'none' ? 'block' : 'none';
    }
    function modeKamera(m) { m==='2D'?viewer.scene.morphTo2D(1):viewer.scene.morphTo3D(1); }
  </script>
</body>
</html>