<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Peta Digital: GeoJSON & 3D Tiles</title>
  
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    body, html { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
    #wadah-peta { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; }

    /* LOADING SCREEN */
    #layar-loading {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85); z-index: 9999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        color: white; transition: opacity 0.5s; pointer-events: none;
    }
    .spinner {
        border: 5px solid #f3f3f3; border-top: 5px solid #007bff;
        border-radius: 50%; width: 50px; height: 50px; animation: putar 1s linear infinite; margin-bottom: 20px;
    }
    @keyframes putar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* PANEL KIRI */
    .panel-kiri { position: absolute; top: 20px; left: 20px; z-index: 20; display: flex; flex-direction: column; gap: 10px; }
    .grup-tombol { background: rgba(255,255,255,0.9); padding: 5px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    .label-grup { font-size: 10px; font-weight: bold; color: #666; margin-bottom: 5px; text-transform: uppercase; }
    button { padding: 8px 12px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; background: #fff; }
    button:hover { background: #f0f0f0; }
    .btn-sumber.aktif { background-color: #6f42c1; color: white; border-color:#6f42c1; } 
    .btn-camera.aktif { background-color: #007bff; color: white; border-color:#007bff; }

    /* PANEL KANAN (GeoJSON Features) */
    .panel-kanan {
      position: absolute; top: 20px; right: 20px; z-index: 10;
      background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 4px;
      display: flex; flex-direction: column; gap: 10px;
    }
    
    /* INFO PANEL */
    #panel-info {
      position: absolute; bottom: 80px; left: 20px; z-index: 20;
      width: 280px; background: white; padding: 15px; display: none; border-left: 5px solid #007bff;
      box-shadow: 0 0 15px rgba(0,0,0,0.3); border-radius: 5px;
    }
    #tabel-properti { width: 100%; border-collapse: collapse; font-size: 12px; }
    #tabel-properti td { border-bottom: 1px solid #eee; padding: 4px; }
    
    /* TOMBOL DOWNLOAD */
    #btn-download {
        position: absolute; bottom: 20px; right: 20px; z-index: 99;
        background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 50px; 
        font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.4); cursor: pointer;
    }
    
    /* DEBUG LOG */
    #debug-log {
        position: absolute; bottom: 0; left: 0; width: 100%; height: 100px;
        background: rgba(0,0,0,0.8); color: lime; font-family: monospace; font-size: 11px;
        overflow-y: scroll; z-index: 99999; padding: 10px; display: none; 
    }
  </style>
</head>
<body>

  <div id="layar-loading">
      <div class="spinner"></div>
      <div id="teks-loading">Memuat Peta...</div>
  </div>

  <div id="wadah-peta"></div>
  <div id="debug-log"></div>

  <div class="panel-kiri">
    <div class="grup-tombol">
        <div class="label-grup">Pilih Data</div>
        <button id="btnGeoJSON" class="btn-sumber aktif" onclick="gantiSumber('geojson')">GeoJSON (Edit)</button>
        <button id="btn3DTiles" class="btn-sumber" onclick="gantiSumber('3dtiles')">3D Tiles (Real)</button>
    </div>
    <div class="grup-tombol">
        <div class="label-grup">Kamera</div>
        <button id="btn2D" class="btn-camera" onclick="modeKamera('2D')">2D</button>
        <button id="btn3D" class="btn-camera aktif" onclick="modeKamera('3D')">3D</button>
    </div>
    <button onclick="toggleDebug()" style="margin-top:10px; background:black; color:lime;">üõ† Cek Log</button>
  </div>

  <div class="panel-kanan" id="panel-fitur-geojson">
    <div style="display:flex; gap:5px;">
        <input type="text" id="inputCari" placeholder="Cari nama...">
        <button onclick="cariBangunan()">üîç</button>
    </div>
  </div>
  <button id="btn-download" onclick="downloadGeoJSON()">üíæ DOWNLOAD DATA BARU</button>

  <div id="panel-info">
    <h4 id="judul-panel">Info</h4>
    
    <div id="konten-geojson">
        <div style="text-align:center; margin-bottom:10px;">Luas: <b id="labelLuas" style="color:#007bff">0</b> m¬≤</div>
        <div style="margin-bottom:10px;">
            <label style="font-size:12px; font-weight:bold;">Nama:</label>
            <input type="text" id="inputNamaBaru" style="width:100%; padding:5px;">
        </div>
        <div style="margin-bottom:10px;">
            <label style="font-size:12px; font-weight:bold;">Jenis:</label>
            <select id="inputJenisBaru" style="width:100%; padding:5px;">
                <option value="Lainnya">-- Pilih --</option>
                <option value="Rumah">Rumah</option>
                <option value="Kantor">Kantor</option>
                <option value="Sekolah">Sekolah</option>
                <option value="Toko">Toko</option>
            </select>
        </div>
        <button onclick="simpanEdit()" style="width:100%; background:#007bff; color:white; border:none; padding:8px;">Update Data</button>
    </div>

    <div id="konten-3dtiles" style="display:none;"><table id="tabel-properti"></table></div>
  </div>

  <script>
    // 1. TOKEN CESIUM (YANG SUDAH BENAR)
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJjNjJmNjllYi0zNWY1LTRjNTUtYjEyZS0xZTJjZTFkYmNmNjciLCJpZCI6MzY3MTgyLCJpYXQiOjE3NjY0NDkyMTd9.04ove0_LwaphuhYqwBzNo8PQ-2ZiK0gXTY1E1Uiy5Kw'; 

    // Logger
    function logDebug(msg, tipe='info') {
        const logDiv = document.getElementById('debug-log');
        const warna = tipe === 'error' ? 'red' : (tipe === 'success' ? '#00ff00' : 'white');
        logDiv.innerHTML += `<div style="color:${warna}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(msg);
    }

    // Setup Viewer
    const viewer = new Cesium.Viewer('wadah-peta', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      imageryProvider: new Cesium.IonImageryProvider({ assetId: 3954 }), 
      geocoder: false, infoBox: false, selectionIndicator: true,
      timeline: false, animation: false, baseLayerPicker: true
    });

    // === TRIK PENTING: AKTIFKAN X-RAY PERMANEN UNTUK SEMUA ===
    // Ini menjamin GeoJSON dan 3D Tiles selalu terlihat walaupun tertanam di tanah
    viewer.scene.globe.depthTestAgainstTerrain = false;
    // ==========================================================

    // Kamera Awal (Jogja)
    viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(110.37, -7.78, 2000),
        orientation: { heading: 0.0, pitch: -Cesium.Math.PI_OVER_TWO, roll: 0.0 }
    });

    let geoJsonSource = null;
    let tilesetSource = null;
    let masterGeoJSON = null;
    let selectedIndex = -1;
    let currentMode = 'geojson';

    // --- 2. LOAD GEOJSON (PERTAMA KALI) ---
    logDebug("Memulai Load GeoJSON...", "info");
    fetch('data_final.geojson')
      .then(res => res.json())
      .then(json => {
          masterGeoJSON = json;
          return Cesium.GeoJsonDataSource.load(json);
      })
      .then(ds => {
          geoJsonSource = ds;
          viewer.dataSources.add(ds);
          
          const entities = ds.entities.values;
          for (let i = 0; i < entities.length; i++) {
              const ent = entities[i];
              ent.indexAsli = i; // Simpan ID untuk edit
              if (ent.polygon) {
                  // Setting agar GeoJSON tidak tenggelam
                  ent.polygon.perPositionHeight = false;
                  ent.polygon.heightReference = Cesium.HeightReference.CLAMP_TO_GROUND;
                  ent.polygon.extrudedHeightReference = Cesium.HeightReference.RELATIVE_TO_GROUND;
                  ent.polygon.extrudedHeight = 15;
                  
                  // Load atribut
                  let jenis = ent.properties.jenis ? ent.properties.jenis.getValue() : "Lainnya";
                  let nama = ent.properties.name ? ent.properties.name.getValue() : "Tanpa Nama";
                  ent.jenisBangunan = jenis;
                  ent.name = nama;
                  updateWarna(ent, jenis);
              }
          }
          logDebug("‚úÖ GeoJSON Berhasil Dimuat!", "success");
          
          // Default: Tampilkan GeoJSON
          geoJsonSource.show = true;
          viewer.zoomTo(ds);
          document.getElementById('layar-loading').style.display = 'none';
      })
      .catch(err => {
          logDebug("‚ùå ERROR GEOJSON: " + err, "error");
          document.getElementById('teks-loading').innerText = "Gagal Load GeoJSON. Cek nama file!";
          // Hilangkan loading screen biar user bisa baca error
           setTimeout(() => { document.getElementById('layar-loading').style.display = 'none'; }, 2000);
      });

    // --- 3. FUNGSI GANTI SUMBER (PERBAIKAN LOGIKA) ---
    async function gantiSumber(tipe) {
        currentMode = tipe;
        document.getElementById('panel-info').style.display = 'none';
        
        // Update Tombol
        document.getElementById('btnGeoJSON').className = tipe==='geojson'?'btn-sumber aktif':'btn-sumber';
        document.getElementById('btn3DTiles').className = tipe==='3dtiles'?'btn-sumber aktif':'btn-sumber';
        
        // Fitur Search/Download hanya ada di GeoJSON
        const fiturGeo = document.getElementById('panel-fitur-geojson');
        const btnDown = document.getElementById('btn-download');
        
        if (tipe === 'geojson') {
            fiturGeo.style.display = 'block';
            btnDown.style.display = 'block';
            
            if(tilesetSource) tilesetSource.show = false; // Sembunyikan 3D Tiles
            if(geoJsonSource) {
                geoJsonSource.show = true; // Munculkan GeoJSON
                viewer.flyTo(geoJsonSource, {duration: 1.0});
            }
        } 
        else if (tipe === '3dtiles') {
            fiturGeo.style.display = 'none';
            btnDown.style.display = 'none';
            
            if(geoJsonSource) geoJsonSource.show = false; // Sembunyikan GeoJSON

            // Load 3D Tiles jika belum ada
            if (!tilesetSource) {
                document.getElementById('layar-loading').style.display = 'flex';
                document.getElementById('teks-loading').innerText = "Mengambil 3D Tiles...";
                
                try {
                    tilesetSource = await Cesium.Cesium3DTileset.fromIonAssetId(4262559);
                    viewer.scene.primitives.add(tilesetSource);
                    
                    // --- FIX ELEVASI 3D TILES (AGAR TIDAK TENGGELAM) ---
                    const heightOffset = 140.0; // Angkat 140 meter
                    const boundingSphere = tilesetSource.boundingSphere;
                    const cartographic = Cesium.Cartographic.fromCartesian(boundingSphere.center);
                    const surface = Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, 0.0);
                    const offset = Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, heightOffset);
                    const translation = Cesium.Cartesian3.subtract(offset, surface, new Cesium.Cartesian3());
                    tilesetSource.modelMatrix = Cesium.Matrix4.fromTranslation(translation);
                    // ----------------------------------------------------

                    // Styling (Warna Oranye biar seragam, atau hapus untuk warna asli putih)
                    tilesetSource.style = new Cesium.Cesium3DTileStyle({
                        color: "color('orange', 1.0)"
                    });

                    logDebug("‚úÖ 3D Tiles Siap!", "success");
                    await viewer.zoomTo(tilesetSource);

                } catch (e) {
                    logDebug("‚ùå ERROR 3D TILES: " + e, "error");
                    alert("Gagal load 3D Tiles: " + e);
                } finally {
                    document.getElementById('layar-loading').style.display = 'none';
                }
            } else {
                tilesetSource.show = true;
                viewer.zoomTo(tilesetSource, {duration: 1.0});
            }
        }
    }

    // --- 4. KLIK HANDLER (HYBRID) ---
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction(function(movement) {
        const picked = viewer.scene.pick(movement.position);
        
        // Reset Info
        document.getElementById('panel-info').style.display = 'none';

        if (!Cesium.defined(picked)) return;

        // A. KLIK GEOJSON
        if (currentMode === 'geojson' && picked.id && picked.id.indexAsli !== undefined) {
            selectedIndex = picked.id.indexAsli;
            const ent = picked.id;
            
            document.getElementById('konten-geojson').style.display = 'block';
            document.getElementById('konten-3dtiles').style.display = 'none';
            document.getElementById('judul-panel').innerText = "Edit GeoJSON";
            
            document.getElementById('inputNamaBaru').value = ent.name;
            document.getElementById('inputJenisBaru').value = ent.jenisBangunan || "Lainnya";

            if (masterGeoJSON) {
                const feature = masterGeoJSON.features[selectedIndex];
                const luas = turf.area(feature);
                document.getElementById('labelLuas').innerText = luas.toFixed(2);
            }
            document.getElementById('panel-info').style.display = 'block';
        }

        // B. KLIK 3D TILES
        else if (currentMode === '3dtiles' && picked instanceof Cesium.Cesium3DTileFeature) {
            document.getElementById('konten-geojson').style.display = 'none';
            document.getElementById('konten-3dtiles').style.display = 'block';
            document.getElementById('judul-panel').innerText = "Info 3D Tiles";
            
            const tabel = document.getElementById('tabel-properti');
            tabel.innerHTML = "";
            const props = picked.getPropertyNames();
            if(props.length > 0) {
                props.forEach(p => tabel.innerHTML += `<tr><td>${p}</td><td>${picked.getProperty(p)}</td></tr>`);
            } else {
                tabel.innerHTML = "<tr><td>Info</td><td>Tidak ada atribut.</td></tr>";
            }
            document.getElementById('panel-info').style.display = 'block';
        }

    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    // FUNGSI PENDUKUNG
    function simpanEdit() {
        if(selectedIndex === -1) return;
        const nama = document.getElementById('inputNamaBaru').value;
        const jenis = document.getElementById('inputJenisBaru').value;
        const luas = document.getElementById('labelLuas').innerText;
        
        const ent = geoJsonSource.entities.values[selectedIndex];
        ent.name = nama;
        ent.jenisBangunan = jenis;
        updateWarna(ent, jenis);
        
        if(masterGeoJSON) {
            masterGeoJSON.features[selectedIndex].properties.name = nama;
            masterGeoJSON.features[selectedIndex].properties.jenis = jenis;
            masterGeoJSON.features[selectedIndex].properties.luas_m2 = parseFloat(luas);
        }
        alert("Data Tersimpan di Memori!");
    }

    function updateWarna(ent, jenis) {
        let col = Cesium.Color.ORANGE;
        if(jenis === 'Sekolah') col = Cesium.Color.RED;
        else if(jenis === 'Kantor') col = Cesium.Color.BLUE;
        else if(jenis === 'Toko') col = Cesium.Color.GREEN;
        else if(jenis === 'Rumah') col = Cesium.Color.YELLOW;
        ent.polygon.material = col.withAlpha(1.0);
    }

    function downloadGeoJSON() {
        if (!masterGeoJSON) return;
        const s = JSON.stringify(masterGeoJSON, null, 2);
        const b = new Blob([s], {type: "application/json"});
        const u = URL.createObjectURL(b);
        const a = document.createElement('a');
        a.href = u; a.download = "data_final_updated.geojson";
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    
    function cariBangunan() {
        if(!geoJsonSource) return;
        const k = document.getElementById('inputCari').value.toLowerCase();
        const ents = geoJsonSource.entities.values;
        for(let i=0; i<ents.length; i++){
            if(ents[i].name.toLowerCase().includes(k)){
                viewer.flyTo(ents[i], {duration:1.5, offset: new Cesium.HeadingPitchRange(0, -0.5, 200)});
                return;
            }
        }
        alert("Tidak ditemukan");
    }

    function toggleDebug() {
        const d = document.getElementById('debug-log');
        d.style.display = d.style.display === 'none' ? 'block' : 'none';
    }
    function modeKamera(m) { m==='2D'?viewer.scene.morphTo2D(1):viewer.scene.morphTo3D(1); }
  </script>
</body>
</html>