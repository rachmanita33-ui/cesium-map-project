<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Peta 3D - Instant View</title>
  
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    body, html { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
    #wadah-peta { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; }

    /* LAYAR LOADING (Biar user tau lagi loading) */
    #layar-loading {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.8); z-index: 9999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        color: white; transition: opacity 0.5s; pointer-events: none;
    }
    .spinner {
        border: 5px solid #f3f3f3; border-top: 5px solid #3498db;
        border-radius: 50%; width: 40px; height: 40px; animation: putar 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes putar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* UI LAINNYA */
    .kotak-tombol { position: absolute; top: 20px; left: 20px; z-index: 10; }
    .btn-mode { padding: 8px 15px; cursor: pointer; font-weight: bold; border: none; border-radius: 4px; margin-right: 5px; }
    .aktif { background-color: #007bff; color: white; }
    .biasa { background-color: white; color: black; }

    .panel-kanan {
      position: absolute; top: 20px; right: 20px; z-index: 10;
      background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 10px;
    }
    .baris-input { display: flex; gap: 5px; }
    #inputCari { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 150px; }
    #btnCari { padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    #filterJenis { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; cursor: pointer;}

    #panel-edit {
      position: absolute; bottom: 80px; left: 20px; z-index: 20;
      width: 280px; background: white; padding: 15px;
      border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.4); display: none; border-left: 5px solid #007bff;
    }
    .input-group { margin-bottom: 10px; }
    .input-group label { display: block; font-size: 12px; margin-bottom: 3px; font-weight: bold;}
    .input-group input, .input-group select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #aaa; }
    .btn-update { background: #007bff; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold;}
    
    #btn-download-final {
        position: absolute; bottom: 20px; right: 20px; z-index: 99;
        background: #dc3545; color: white; padding: 12px 25px; 
        border: none; border-radius: 50px; cursor: pointer; 
        font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        font-size: 14px; display: flex; align-items: center; gap: 10px;
    }
  </style>
</head>
<body>

  <div id="layar-loading">
      <div class="spinner"></div>
      <div id="teks-loading">Menyiapkan Peta...</div>
  </div>

  <div id="wadah-peta"></div>

  <div class="kotak-tombol">
    <button id="tombol2D" class="btn-mode biasa" onclick="ubahKe2D()">2D</button>
    <button id="tombol3D" class="btn-mode aktif" onclick="ubahKe3D()">3D</button>
  </div>

  <div class="panel-kanan">
    <div class="baris-input">
        <input type="text" id="inputCari" placeholder="Cari nama..." onkeypress="cekEnter(event)">
        <button id="btnCari" onclick="cariBangunan()">üîç</button>
    </div>
    <select id="filterJenis" onchange="filterBangunan()">
        <option value="Semua">-- Filter Jenis --</option>
        <option value="Rumah">Rumah</option>
        <option value="Kantor">Kantor</option>
        <option value="Sekolah">Sekolah</option>
        <option value="Toko">Toko</option>
        <option value="Lainnya">Lainnya</option>
    </select>
  </div>

  <div id="panel-edit">
    <h4>üìê Info Bangunan</h4>
    <div style="text-align:center; margin-bottom:10px;">Luas: <b id="labelLuas" style="color:#007bff">0</b> m¬≤</div>
    <div class="input-group"><label>Nama:</label><input type="text" id="inputNamaBaru"></div>
    <div class="input-group">
        <label>Jenis:</label>
        <select id="inputJenisBaru">
            <option value="Lainnya">-- Pilih --</option>
            <option value="Rumah">Rumah</option>
            <option value="Kantor">Kantor</option>
            <option value="Sekolah">Sekolah</option>
            <option value="Toko">Toko</option>
        </select>
    </div>
    <button class="btn-update" onclick="simpanPerubahanKeMemori()">Update Data</button>
  </div>

  <button id="btn-download-final" onclick="downloadGeoJSON()">üíæ DOWNLOAD DATA BARU</button>

  <script>
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzNDc5MTNmZC0xNGU5LTQwNmEtYmQzYy0zMjY0MTZmMWExN2EiLCJpZCI6MzY3MTgyLCJpYXQiOjE3NjUwMjEwNzJ9.RQ0mXPjl4CXLkx5tWpdS2NwAYT_v3zoS3McVOhrnTfc'; 
    
    // 1. SETUP VIEWER
    const viewer = new Cesium.Viewer('wadah-peta', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      imageryProvider: new Cesium.IonImageryProvider({ assetId: 3954 }), // Asset ID Aman
      geocoder: false, infoBox: false, selectionIndicator: true,
      timeline: false, animation: false, sceneModePicker: false, baseLayerPicker: true
    });

    // === SOLUSI LAYAR HITAM: SET POSISI AWAL ===
    // Kita paksa kamera melihat ke Yogyakarta/Jateng SEBELUM data gedung dimuat.
    // Jadi minimal user lihat peta, bukan lihat kegelapan.
    viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(110.37, -7.78, 2000), // Koordinat Jogja, tinggi 2000m
        orientation: { heading: 0.0, pitch: -Cesium.Math.PI_OVER_TWO, roll: 0.0 }
    });
    // ============================================

    let masterGeoJSON = null; 
    let cesiumDataSource = null;  
    let selectedFeatureIndex = -1;

    // 2. LOAD DATA
    const fileGedung = 'data_final.geojson'; 

    fetch(fileGedung)
      .then(response => response.json())
      .then(jsonData => {
          masterGeoJSON = jsonData;
          document.getElementById('teks-loading').innerText = "Menggambar Gedung...";
          return Cesium.GeoJsonDataSource.load(jsonData);
      })
      .then(dataSource => {
          cesiumDataSource = dataSource;
          viewer.dataSources.add(dataSource);
          
          // Zoom Presisi ke Gedung (Setelah data siap)
          viewer.zoomTo(dataSource, new Cesium.HeadingPitchRange(0, -0.7, 800))
            .then(() => {
                // Hilangkan Loading Screen
                const loading = document.getElementById('layar-loading');
                loading.style.opacity = 0;
                setTimeout(() => { loading.style.display = 'none'; }, 500);
            });

          const entities = dataSource.entities.values;

          for (let i = 0; i < entities.length; i++) {
              const entity = entities[i];
              entity.indexAsli = i; 

              if (entity.polygon) {
                  entity.polygon.perPositionHeight = false; 
                  entity.polygon.heightReference = Cesium.HeightReference.CLAMP_TO_GROUND;
                  entity.polygon.extrudedHeightReference = Cesium.HeightReference.RELATIVE_TO_GROUND;
                  entity.polygon.extrudedHeight = 15; 
                  entity.polygon.material = Cesium.Color.ORANGE.withAlpha(1.0); 
                  entity.polygon.outline = true;
                  entity.polygon.outlineColor = Cesium.Color.BLACK;

                  let nama = entity.properties.name ? entity.properties.name.getValue() : "Tanpa Nama";
                  let jenis = entity.properties.jenis ? entity.properties.jenis.getValue() : "Lainnya";
                  entity.name = nama;
                  entity.jenisBangunan = jenis; 
                  updateWarna(entity, jenis);
              }
          }
      })
      .catch(error => {
          console.error("Error:", error);
          document.getElementById('teks-loading').innerHTML = "Gagal Load Data!<br>Cek nama file GeoJSON.";
      });

    // FUNGSI LOGIKA (SAMA SEPERTI SEBELUMNYA)
    viewer.selectedEntityChanged.addEventListener(function(entity) {
        const panel = document.getElementById('panel-edit');
        if (entity && typeof entity.indexAsli !== 'undefined') {
            selectedFeatureIndex = entity.indexAsli;
            document.getElementById('inputNamaBaru').value = entity.name;
            document.getElementById('inputJenisBaru').value = entity.jenisBangunan || "Lainnya";
            
            const featureAsli = masterGeoJSON.features[selectedFeatureIndex];
            if (featureAsli) {
                const luas = turf.area(featureAsli); 
                document.getElementById('labelLuas').innerText = luas.toFixed(2);
            }
            panel.style.display = 'block';
        } else {
            panel.style.display = 'none';
        }
    });

    function simpanPerubahanKeMemori() {
        if (selectedFeatureIndex === -1) return;
        const nama = document.getElementById('inputNamaBaru').value;
        const jenis = document.getElementById('inputJenisBaru').value;
        const luas = document.getElementById('labelLuas').innerText;
        
        const entityVisual = cesiumDataSource.entities.values[selectedFeatureIndex];
        entityVisual.name = nama;
        entityVisual.jenisBangunan = jenis;
        updateWarna(entityVisual, jenis);

        if (masterGeoJSON.features[selectedFeatureIndex]) {
            masterGeoJSON.features[selectedFeatureIndex].properties.name = nama;
            masterGeoJSON.features[selectedFeatureIndex].properties.jenis = jenis;
            masterGeoJSON.features[selectedFeatureIndex].properties.luas_m2 = parseFloat(luas);
        }
        alert("Data Terupdate!");
    }

    function updateWarna(entity, jenis) {
        let warna = Cesium.Color.ORANGE.withAlpha(1.0);
        if (jenis === "Sekolah") warna = Cesium.Color.RED.withAlpha(1.0);
        if (jenis === "Kantor") warna = Cesium.Color.BLUE.withAlpha(1.0);
        if (jenis === "Toko") warna = Cesium.Color.GREEN.withAlpha(1.0);
        if (jenis === "Rumah") warna = Cesium.Color.YELLOW.withAlpha(1.0);
        entity.polygon.material = warna;
    }

    function filterBangunan() {
        const jenis = document.getElementById('filterJenis').value;
        const entities = cesiumDataSource.entities.values;
        for (let i = 0; i < entities.length; i++) {
            if (jenis === "Semua") entities[i].show = true;
            else entities[i].show = (entities[i].jenisBangunan === jenis);
        }
    }

    function downloadGeoJSON() {
        if (!masterGeoJSON) return;
        const dataStr = JSON.stringify(masterGeoJSON, null, 2);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = "data_final_updated.geojson"; 
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function cariBangunan() {
        const kata = document.getElementById('inputCari').value.toLowerCase();
        const entities = cesiumDataSource.entities.values;
        for (let i = 0; i < entities.length; i++) {
            if (entities[i].name.toLowerCase().includes(kata)) {
                viewer.flyTo(entities[i], { duration: 1.5, offset: new Cesium.HeadingPitchRange(0, -0.5, 200) });
                viewer.selectedEntity = entities[i];
                break;
            }
        }
    }
    function cekEnter(e) { if (e.key === "Enter") cariBangunan(); }

    const btn2D = document.getElementById('tombol2D');
    const btn3D = document.getElementById('tombol3D');
    function ubahKe2D() {
      viewer.scene.morphTo2D(1);
      btn2D.className = "btn-mode aktif"; btn3D.className = "btn-mode biasa"; 
      if (cesiumDataSource) viewer.flyTo(cesiumDataSource, { duration: 2.0 });
    }
    function ubahKe3D() {
      viewer.scene.morphTo3D(1);
      btn2D.className = "btn-mode biasa"; btn3D.className = "btn-mode aktif"; 
      if (cesiumDataSource) viewer.flyTo(cesiumDataSource, { duration: 2.0, offset: new Cesium.HeadingPitchRange(0, -0.7, 800) });
    }
  </script>
</body>
</html>