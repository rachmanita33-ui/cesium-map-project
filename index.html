<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Peta 3D - Hitung Luas</title>
  
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    body, html { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
    #wadah-peta { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

    /* UI TOMBOL */
    .kotak-tombol { position: absolute; top: 20px; left: 20px; z-index: 10; }
    .btn-mode { padding: 8px 15px; cursor: pointer; font-weight: bold; border: none; border-radius: 4px; margin-right: 5px; }
    .aktif { background-color: #007bff; color: white; }
    .biasa { background-color: white; color: black; }

    /* PANEL KANAN */
    .panel-kanan {
      position: absolute; top: 20px; right: 20px; z-index: 10;
      background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 10px;
    }
    .baris-input { display: flex; gap: 5px; }
    #inputCari { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 150px; }
    #filterJenis { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; cursor: pointer;}
    #btnCari { padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }

    /* PANEL EDIT & INFO */
    #panel-edit {
      position: absolute; bottom: 80px; left: 20px; z-index: 20;
      width: 280px; background: white; padding: 15px;
      border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.4);
      display: none; border-left: 5px solid #007bff;
    }
    #panel-edit h4 { margin-top: 0; margin-bottom: 10px; color: #333; }
    .input-group { margin-bottom: 10px; }
    .input-group label { display: block; font-size: 12px; margin-bottom: 3px; font-weight: bold;}
    .input-group input, .input-group select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #aaa; }
    
    /* TAMPILAN LUAS */
    .info-luas {
        background: #e9ecef; padding: 10px; border-radius: 4px; 
        text-align: center; margin-bottom: 10px; font-weight: bold; color: #495057;
    }

    .btn-update { background: #007bff; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold;}
    .btn-update:hover { background: #0056b3; }

    #btn-download-final {
        position: absolute; bottom: 20px; right: 20px; z-index: 99;
        background: #dc3545; color: white; padding: 12px 25px; 
        border: none; border-radius: 50px; cursor: pointer; 
        font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        font-size: 14px; display: flex; align-items: center; gap: 10px;
    }
    #btn-download-final:hover { background: #a71d2a; transform: scale(1.05); }
  </style>
</head>
<body>

  <div id="wadah-peta"></div>

  <div class="kotak-tombol">
    <button id="tombol2D" class="btn-mode biasa" onclick="ubahKe2D()">2D</button>
    <button id="tombol3D" class="btn-mode aktif" onclick="ubahKe3D()">3D</button>
  </div>

  <div class="panel-kanan">
    <div class="baris-input">
        <input type="text" id="inputCari" placeholder="Cari nama..." onkeypress="cekEnter(event)">
        <button id="btnCari" onclick="cariBangunan()">üîç</button>
    </div>
    <select id="filterJenis" onchange="filterBangunan()">
        <option value="Semua">-- Filter Jenis --</option>
        <option value="Rumah">Rumah</option>
        <option value="Kantor">Kantor</option>
        <option value="Sekolah">Sekolah</option>
        <option value="Toko">Toko</option>
        <option value="Lainnya">Lainnya</option>
    </select>
  </div>

  <div id="panel-edit">
    <h4>üìê Info Bangunan</h4>
    
    <div class="info-luas">
        Luas: <span id="labelLuas" style="color: #007bff; font-size: 16px;">0</span> m¬≤
    </div>

    <div class="input-group">
        <label>Nama Gedung:</label>
        <input type="text" id="inputNamaBaru">
    </div>

    <div class="input-group">
        <label>Jenis Bangunan:</label>
        <select id="inputJenisBaru">
            <option value="Lainnya">-- Pilih Jenis --</option>
            <option value="Rumah">Rumah</option>
            <option value="Kantor">Kantor</option>
            <option value="Sekolah">Sekolah</option>
            <option value="Toko">Toko</option>
        </select>
    </div>

    <button class="btn-update" onclick="simpanPerubahanKeMemori()">Update Data</button>
  </div>

  <button id="btn-download-final" onclick="downloadGeoJSON()">üíæ DOWNLOAD DATA BARU</button>

  <script>
    // 1. TOKEN CESIUM
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzNDc5MTNmZC0xNGU5LTQwNmEtYmQzYy0zMjY0MTZmMWExN2EiLCJpZCI6MzY3MTgyLCJpYXQiOjE3NjUwMjEwNzJ9.RQ0mXPjl4CXLkx5tWpdS2NwAYT_v3zoS3McVOhrnTfc'; 
    
    // 2. SETUP VIEWER
    const viewer = new Cesium.Viewer('wadah-peta', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      imageryProvider: new Cesium.IonImageryProvider({ assetId: 2 }), 
      geocoder: false, infoBox: false, selectionIndicator: true,
      timeline: false, animation: false, sceneModePicker: false, baseLayerPicker: true
    });

    let masterGeoJSON = null; 
    let cesiumDataSource = null;  
    let selectedFeatureIndex = -1;

    // 3. LOAD DATA
    const fileGedung = 'data_final.geojson'; 

    fetch(fileGedung)
      .then(response => response.json())
      .then(jsonData => {
          masterGeoJSON = jsonData;
          return Cesium.GeoJsonDataSource.load(jsonData);
      })
      .then(dataSource => {
          cesiumDataSource = dataSource;
          viewer.dataSources.add(dataSource);
          viewer.zoomTo(dataSource, new Cesium.HeadingPitchRange(0, -0.7, 800));

          const entities = dataSource.entities.values;

          for (let i = 0; i < entities.length; i++) {
              const entity = entities[i];
              entity.indexAsli = i; 

              if (entity.polygon) {
                  // FIX VISUAL
                  entity.polygon.perPositionHeight = false; 
                  entity.polygon.heightReference = Cesium.HeightReference.CLAMP_TO_GROUND;
                  entity.polygon.extrudedHeightReference = Cesium.HeightReference.RELATIVE_TO_GROUND;
                  entity.polygon.extrudedHeight = 15; 
                  entity.polygon.material = Cesium.Color.ORANGE.withAlpha(1.0); 
                  entity.polygon.outline = true;
                  entity.polygon.outlineColor = Cesium.Color.BLACK;

                  // LOAD DATA AWAL
                  let namaAwal = entity.properties.name ? entity.properties.name.getValue() : "Tanpa Nama";
                  let jenisAwal = entity.properties.jenis ? entity.properties.jenis.getValue() : "Lainnya";
                  
                  entity.name = namaAwal;
                  entity.jenisBangunan = jenisAwal; 

                  // CEK WARNA AWAL BERDASARKAN JENIS
                  updateWarna(entity, jenisAwal);
              }
          }
      })
      .catch(error => console.error("Error loading:", error));

    // 4. FUNGSI KLIK (HITUNG LUAS DI SINI)
    viewer.selectedEntityChanged.addEventListener(function(entity) {
        const panel = document.getElementById('panel-edit');
        
        if (entity && typeof entity.indexAsli !== 'undefined') {
            selectedFeatureIndex = entity.indexAsli;
            
            // ISI FORM
            document.getElementById('inputNamaBaru').value = entity.name;
            document.getElementById('inputJenisBaru').value = entity.jenisBangunan || "Lainnya";
            
            // --- HITUNG LUAS PAKAI TURF.JS ---
            // Kita ambil geometri asli dari JSON mentah
            const featureAsli = masterGeoJSON.features[selectedFeatureIndex];
            
            if (featureAsli) {
                // Hitung luas (hasilnya meter persegi)
                const luas = turf.area(featureAsli); 
                // Tampilkan dengan 2 angka di belakang koma (misal: 150.45)
                document.getElementById('labelLuas').innerText = luas.toFixed(2);
            } else {
                document.getElementById('labelLuas').innerText = "0";
            }
            // ---------------------------------

            panel.style.display = 'block';
        } else {
            panel.style.display = 'none';
            selectedFeatureIndex = -1;
        }
    });

    // 5. UPDATE DATA
    function simpanPerubahanKeMemori() {
        if (selectedFeatureIndex === -1 || !masterGeoJSON) return;

        const namaBaru = document.getElementById('inputNamaBaru').value;
        const jenisBaru = document.getElementById('inputJenisBaru').value;
        const luasTerhitung = document.getElementById('labelLuas').innerText;
        
        // A. UPDATE VISUAL
        const entities = cesiumDataSource.entities.values;
        const entityVisual = entities[selectedFeatureIndex];
        
        entityVisual.name = namaBaru;
        entityVisual.jenisBangunan = jenisBaru;
        updateWarna(entityVisual, jenisBaru);

        // B. UPDATE JSON (Simpan Luas juga ke file!)
        if (masterGeoJSON.features[selectedFeatureIndex]) {
            masterGeoJSON.features[selectedFeatureIndex].properties.name = namaBaru;
            masterGeoJSON.features[selectedFeatureIndex].properties.jenis = jenisBaru;
            
            // Kita simpan luasnya jadi kolom baru bernama "luas_m2"
            masterGeoJSON.features[selectedFeatureIndex].properties.luas_m2 = parseFloat(luasTerhitung);
        }

        alert("Data Tersimpan!\nLuas: " + luasTerhitung + " m¬≤\nJenis: " + jenisBaru);
    }

    // FUNGSI GANTI WARNA
    function updateWarna(entity, jenis) {
        let warna = Cesium.Color.ORANGE.withAlpha(1.0);
        if (jenis === "Sekolah") warna = Cesium.Color.RED.withAlpha(1.0);
        if (jenis === "Kantor") warna = Cesium.Color.BLUE.withAlpha(1.0);
        if (jenis === "Toko") warna = Cesium.Color.GREEN.withAlpha(1.0);
        if (jenis === "Rumah") warna = Cesium.Color.YELLOW.withAlpha(1.0);
        entity.polygon.material = warna;
    }

    // 6. FILTER
    function filterBangunan() {
        const jenisDipilih = document.getElementById('filterJenis').value;
        const entities = cesiumDataSource.entities.values;

        for (let i = 0; i < entities.length; i++) {
            const entity = entities[i];
            if (jenisDipilih === "Semua") {
                entity.show = true;
            } else {
                entity.show = (entity.jenisBangunan === jenisDipilih);
            }
        }
    }

    // 7. DOWNLOAD
    function downloadGeoJSON() {
        if (!masterGeoJSON) return;
        const dataStr = JSON.stringify(masterGeoJSON, null, 2);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "data_final_updated.geojson"; 
        document.body.appendChild(a);
        a.click(); 
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // UTILS
    function cariBangunan() {
        const kata = document.getElementById('inputCari').value.toLowerCase();
        const entities = cesiumDataSource.entities.values;
        for (let i = 0; i < entities.length; i++) {
            if (entities[i].name.toLowerCase().includes(kata)) {
                viewer.flyTo(entities[i], { duration: 1.5, offset: new Cesium.HeadingPitchRange(0, -0.5, 200) });
                viewer.selectedEntity = entities[i];
                break;
            }
        }
    }
    function cekEnter(e) { if (e.key === "Enter") cariBangunan(); }
    const btn2D = document.getElementById('tombol2D');
    const btn3D = document.getElementById('tombol3D');
    function ubahKe2D() {
      viewer.scene.morphTo2D(1);
      btn2D.className = "btn-mode aktif"; btn3D.className = "btn-mode biasa"; 
      if (cesiumDataSource) viewer.flyTo(cesiumDataSource, { duration: 2.0 });
    }
    function ubahKe3D() {
      viewer.scene.morphTo3D(1);
      btn2D.className = "btn-mode biasa"; btn3D.className = "btn-mode aktif"; 
      if (cesiumDataSource) viewer.flyTo(cesiumDataSource, { duration: 2.0, offset: new Cesium.HeadingPitchRange(0, -0.7, 800) });
    }
  </script>

</body>
</html>